    * identification of mme and mobile subscriber
** mobile identification
IMSI: unique international mobile sbuscriber identity

TMSI(Temporary Mobile subscriber indenties)
 In order to support the subscriber identity confidentiality service the VLRs, SGSNs and MMEs may allocate Temporary Mobile Subscriber Identities (TIMSI) to 
 visiting mobile subscribers. The VLR, SGSN, and MME must be capable of correlating an allocated TIMSI with the IMSI of the Mobile Station (MS) to which it is allocated.

An MS may be allocated three TMSIs, one for services provided through the MSC, one for services provided through the SGSN (P-TIMSI for short) and i
one for the services provided via the MME (M-TIMSI which is part of GUTI).

IMEI (International Mobile Equipment Identity) it is a unique number given to every single mobile phone.
(When a phone is reported stolen or is not type approved, the number is marked invalid).

The IMEI (International Mobile Station Equipment Identity) is a 15-digit number to uniquely identify a mobile phone device.i
IMEISV (IMEI Software Version) is a 16-digit number with the IMEI and an additional software version number.


*** composition of IMSI
|     IMSI   |
 MCC MNC MSIN
    | NMSI   |
MSIN: Moblie subscriber identification number
    Mobile Country Code (MCC) consisting of three digits. The MSS identifies uniquely the country of domicile of mobile subscriber. 
    Mobile Network Code (MNC) consisting of two or three digits for GSM/UMTS applications.  That's why, if you are close to your country border UE is still using eNodeBs 
    that belongs/are controled by Mobile Operator from your country. In other words .. the MNC identifies the home PLMN of the mobile subscriber. The length of the MNC 
    (two or three digits) depends on the value of the MCC. A mixture of two and three digit MNC codes within a single MCC area is not recommended according to 3GPP specification.
    Mobile Subscriber Identification Number (MSIN) identifying the mobile subscriber within a PLMN.

In Fig. 1. there is also shown NMSI entity. The National Mobile Subscriber Identity (NMSI) consists of the MNC and the NMSI.

this will be allocated to each mobile subsriber in every (GSM, UMTS and EPS)sytem.

** Globally Unique MME id(GUMMEI)
-----    MCC: 244 ---finland
         MNC: 123  ---LTE4U
gummei   MMEGID: 1
______   MMEC :1
Globally Unique MME Identifier (GUMMEI)
The format and size of the GUTI is:
GUTI = GUMMEI + M-TMSI, where
GUMMEI = MCC + MNC + MME Identifier and
MME Identifier = MME Group ID + MME Code
MCC and MNC shall have the same field size as in earlier 3GPP systems.
M-TMSI shall be of 32 bits length.
MME Group ID shall be of 16 bits length.
MME Code shall be of 8 bits length.




    ** Globally Unique Temporary UE Identity (GUTI )
The purporse of the GUTI is to provife an unambiguous identification of the UE that does not reveal the UE or the user's permanent identity in the Evolved Packet System
(EPS). It also allows the identification of the MME and network. It can be used by network and the UE to establish UE's identity during signaling between them in EPS.
On GUTI consist two main components:

    GUMMEI - that uniquely identifies the MME which has allocated the GUTI
    M-TMSI - other that uniquely identifies the UE within the MME because of allocated the GUTI

Because of that when UE is contacting the network it sends the GUTI to the eNodeB which then uses the GUTI number to identify to which MME re-establish request will be send.
If the UE has moved from UMTS cell to LTE cell, a TAU procedure is made (because UE does not have its GUTI) and P-TMSI is send. By this way MME, which is in control of
area to which UE moved to, can contact SGSN, which controlled area where UE was previously, to request the subscribers current profile like IP address and PDP contexts.
Situation is similiar when UE has moved from LTE to UMTS cell. GUTI is sent as the P-TMSI parameter and the procedure is reffered as Routing Area Update (RAU).
If there is a situation where eNodeB from new LTE cell is not associated with MME on which GUMMEI is pointing eNodeB simply will select new MME. The new MME 
could get context information from old MME using same GUTI.


-       GUTI=<GUMMEI><M-TMSI>
Fig. 2. GUTI structure

-       GUTI=<GUMMEI><M-TMSI>
-	GUMMEI=<MCC><MNC><MME group Id><MME Code>
-	Mapped GUMMEI=<MCC><MNC><MME group Id=LAC><MME Code=8 MSB of NRI>


** MSISDN
the real phone number, is is stored with other information in HLR indexed by imsi of each entry
MSISDN = CC + NDC + SN
CC = Country Code
NDC = National Destination Code
SN = Subscriber Number

* PDN, bearer and APN
** PDN concept
In that home, the APN comes into play inside the Home Subscriber Server (HSS) node of the core network.

Where You’ll See LTE APN

The HSS contains users’ SAE subscription data such as the EPS-subscribed Quality of Service (QoS) profile and any access restrictions for roaming. HSS also contains
information about the (Pocket Data Networks) PDNs to which the user can connect, as reported by Alcatel-Lucent. “This could be in the form of an access point name (APN) (which is a label according to DNS naming conventions describing thei
access point to the PDN) or a PDN address (indicating subscribed IP address(es)). In addition the HSS holds dynamic information such as the identity of the MME to which the user
is currently attached or registered. The HSS may also integrate the authentication center (AUC), which generates the vectors for authentication and security keys.” [1]

 What LTE APN Does

 To break it down, the APN identifies a Gateway GPRS Support Node (GGSN) or Packet Data Network GateWay (P-GW). It includes an APN network identifier which defines the Packet Data 
 Network (PDN) to which the UE requests connectivity, and may also include an APN operator identifier which defines in which Public Land Mobile Network (PLMN) the P-GW or
 GGSN is located, according to LTE World. [2] To accomplish this, the APN structure is comprised into two parts: a network identifier and an operator identifier.

  How to identify?

  There are also steps for identifying a PDN IP network that the mobile data user wants to communicate with. The NMC Consulting Group notes that the PDN Identity (APN) is used to
  determine the P-GW and point of interconnection with a PDN. With APN as query parameter to the DNS procedures, the MME will receive a list of candidate P-GWs, and then a P-GW is 
  selected by MME with policy. [3]

  3GPP Views

  The board who sets the standards for 3GPP, however, sees things a little differently. According to the new standards puts in place, the UE shall not include APN and PCO in the 
  PDN connectivity request when the same is sent along with attach request. 3GPP has said that the UE shall send the PDN connectivity request with a flag “ESM Information transfer”
  on and no APN or PCO shall be included. Once the MME receives the Attach Request+PDN connectivity request, it can move ahead and accept the attach but it still cannot establish
  the EPS bearers just yet.
  Next, MME goes ahead with establishing security context. After the security context is established MME will send a NAS message “ESM Information Request” asking UE for APN and PCO. 
  Then, the UE will send an “ESM Information Response” with APN and PCO, encrypted. Finally, once MME receives this response it will go ahed with establishing the EPS bearers.
  If the response doesn’t include APN then default APN shall be used by MME.

*** EPS Session

IP connection between a UE and a PDN is called PDN connection or EPS session. Each PDN connection (or EPS session) is represented by an IP address of the UE and a PDN ID (in other words,
 Access Point Name (APN)). It has more than one EPS bearer to deliver user traffic (IP packets), and applies the service quality (QoS) policy obtained from a PCRF to the EPS bearers.
 The minimum fundamental bearer that an EPS session has for a PDN is called a default EPS bearer.

 
Having an EPS session established means 
i) a PDN through which a user is to use services has been selected (by the user’s input or based on the subscription information provisioned by an HSS), 
ii) an IP address to be used in the PDN has been assigned to the user, 
iii) policy rules to be applied to the user IP packets (QoS and charging rules) have been selected,
iv) a default EPS bearer for delivering IP packets over the LTE network has been established. 
Through this EPS session established, IP packets can be exchanged between the user and the PDN according to the rules set by the operator.

Management and operation of sessions, including PCRF, will be explained in other document, and a PDN ID (APN) will be discussed as an ID relating to the EPS session in this document.


*** EPS Bearer

An EPS session is in charge of delivering and handling flows of the IP packets that are labeled with UE IP addresses and travel between a UE and a PDN (UE – P-GW – PDN).
 On the other hand, an EPS bearer is a pipe through which IP packets are delivered over the LTE network, i.e., between a UE and a P-GW (UE – eNB – S-GW - P-GW).
 A UE can have multiple EPS bearers concurrently. So, different EPS bearers are identified by their EPS bearer ID, which is allocated by an MME.

As seen in Figure 1, an EPS bearer actually is a concatenation of the following three bearers (DRB, S1 bearer and S5 bearer):

    [UE] - [eNB]: Data Radio Bearer (DRB)

EPS bearer established over LTE-Uu interface. User traffic (IP packet) is delivered through a DRB. Different DRBs are identified by their DRB ID, which is allocated by an eNB.

    [eNB] - [S-GW]: S1 bearer

EPS bearer established over S1-U interface. User traffic is delivered through a GTP tunnel. Different S1 bearers are identified by their tunnel endpoint identifier (TEID), which is allocated by the endpoints (eNB and S-GW) of the GTP tunnel. 

    [S-GW] - [P-GW]: S5 bearer

EPS bearer established over S5 interface. User traffic is delivered through a GTP tunnel. Different S5 bearers are identified by their tunnel endpoint identifier (TEID), which is allocated by the endpoints (S-GW and P-GW) of the GTP tunnel.

*** Types of EPS Bearers
Before we go ahead and describe EPS bearer-related IDs, we will look at different types of EPS bearers and how they work. Figure 2 shows two different types of EPS bearers:
default and dedicated. Each PDN must have one default EPS bearer, but may have none to many dedicated EPS bearers.

The LTE network is an all-IP network, and provides its users with always-on IP connectivity. This means, once a UE connects to a PDN using the IP address assigned at its initial attach 
to the network, the IP connection remains connected after a default EPS bearer is established over the LTE network and until the UE detaches from the LTE network 
(i.e., the PDN connection is terminated). Even when there is no user traffic to send, the default EPS bearer always stays activated and ready for possible incoming user traffic.

Additional EPS bearer can be established if the default EPS bearer itself is not sufficient enough to obtain QoS (see LTE QoS document). The additional EPS bearer established 
is called a dedicated EPS bearer and multiple dedicated bearers can be created if required by the user or the network. When there is no user traffic, these dedicated EPS bearers 
can be removed, whereas the default one is never removed and keeps the user staying connected to the network unless the user detaches from the network. Dedicated EPS bearers are linked to
a default EPS bearer. The linked bearers are represented by a Linked EPS Bearer Identity (LBI), indicating they are all associated with the same default EPS bearer.


*** ID to identify PDN: PDN ID (APN)
PDNs are identified by PDN IDs (or Access Point Names (APNs)). An APN, as can be easily inferred, refers to an access point to a PDN where a user wishes to connect for services/applications.
APNs and their format are illustrated. An APN is a combination of a network ID and an operator ID. The network ID is used when identifying PDNs such as Internet or Corporate VPNs or 
identifying services like IMS that the PDN provides.
An APN is provisioned to an HSS as subscription information at the time of a user’s subscription (as in case 1 of Figure 3)2. Upon a UE’s initial attach, a default APN is 
downloaded from the HSS to an MME. The MME selects a PDN to connect the UE based on the APN first, and then a P-GW through which the UE is connected to the PDN . 
the MME selected PDN 1 based on APN 1, and then P-GW 1 for connection to PDN 1.  

 
http://www.netmanias.com/en/post/techdocs/5907/identification-identifier-lte/lte-identification-iii-eps-session-bearer-identifiers


\\10.140.0.65\data\EPC MME\01. Architecture\Basic LTE procedures

* basic procedures
state of UE
 ECM=idle/connected       (means UE is not connected to radio network's ENB)
 EMM=registered/deregistered       (means UE is registered in core network's MME)

** S1 Setup
this procedure triggered when network element in core network first bootup
*** network element configuration(enb1, enb2, one mme)
enb1: own ip addr 13           enb2: ipaddr:12          mme: ipaddr:11
     MCC: 244                       MCC: 244                  MCC: 244   
     MNC: 123                       MNC: 123                  MNC: 123
     enB ID:2                       enB ID:2                  mmegid:mmecode 2:0
     Tal: Ta1, Ta2                  Tal: Ta2,Ta3              capacity: 25 

when all system boot up, enb1 and enb2 will send a S1 Setup message to mme tell it's enbid and Tal
and mme will store the global enb id and taList to it's database
then response them with its own gummei and  capacity


*** s1 setup request procedure
enb will establish a sctp connection to mme, and notify mme that its Tracking area

enb1:TA1     S1 setup request( enbid, TA1,TA2)
     TA2    ------------------------------------>   MME [enbid, Talist]
           
              S1 setup response(gummei,capacity)
	    <------------------------------------

** S1 Release (S1 release it not the opposit operation of S1 Setup, S1 release is related to UE, but s1 setup has nothing to do with UE)
when enb found  ue lose rrc connection(radio connect) to it, there will be s1 release procedure, started by enb.
ue  ECM = idle

enb detected that ue is lost, it will send a ue context release rquest(enb_s1ap_id, mme_s1ap_id, cause of release) to mme

sgw will remove enb related info, enb will remove all the info related to the attach()
mme will remove ue-associated info ims1 and enb_s1ap_id


S1 release procedure will make all s1ap related id removed in mme, sgw, but UE keep GUTI,TAI.(for if UE move to another ENB, the info not related to the older enb is also useful).

enb: enb-s1-id, mme-s1-id,      mme:imsi,guti(TMSI),enb-s1-id,mme-s1-id,          sgw:imsi, mme-teid,sgw-teid-c
enb-teid, sgw-teid-u                guti, mme-teid, sgw-teid-c,sgw-teid-u         sgw-teid-u,enb-teid
|                                    |                                            |
|ue context release request(enb-s1-id|                                            |
|mme-s1ap-id, casue of release)      |                                            |
|----------------------------------->|                                            |
|                                    |                                            |
|                                    |                                            |
|                                    |release access bearers request(SGW TEID-C)  |  
|                                    |------------------------------------------->|(enb-teid)Remove
|                                    |                                            |---------
|                                    |                                            |
|                                    |release aceess bearers response             |
|                                    |<-------------------------------------------|
|                                    |                                            |
|ue context release command(         |
| enb-s1-id,mme-s1-id)               |
|<-----------------------------------|
|                                    |
|(all the filed above)Remove         |
|                                    |
|                                    |
|ue context release complete         |
|(enb-s1-id, mme-s1-id)              |
|----------------------------------->|(enb-s1ap-id,mme-s1ap-id) Remove
                                  EMM=registered,ECM=idle


** Service Request (this is the opposite operation of S1 release)

when after s1 release, ue ecm=idle emm=registered
ue want to send some message, it will establish RRC connection to enb and sending Service Request NAS Message

ue                     enb                              mme                                      sgw
guti,talist            none                  imsi,guti,mme-teid,sgw-teid(u/c)          imsi,mme-teid,sgw-teid(u/c)
|                        |                                       |                                      |
| service requst(S-TMSI) |                                       |                                      |
|------------------------+---------------------------------------+--------------------------------------|
|                        | [enb-s1ap-id]                         |                                      |
|                        |                                       |                                      |
|                        | initial ue message(enb-s1ap-id,       |                                      |
|                        | S-TMSI,<servic request>)              |                                      |
|                        | ----------------------------------->  |                                      |
|                        |                                       | [mme-s1ap-id]                        |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | initial context setup req             |                                      |
|                        | (enb-s1ap-id,mme-s1ap-id, sgw-teid-u) |                                      |
|                        | <----------------------------------   |                                      |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | [enb-teid]                            |                                      |
|                        | <mme-s1ap-id,sgw-teid-u>              |                                      |
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        | first uplink data packet              |                                      |
|------------------------+---------------------------------------+--------------------------------------|
|                        |                                       |                                      |
|                        | initial context respose               |                                      |
|                        | (enb-s1ap-id,mme-s1ap-id,enb-teid)    |                                      |
|                        | ----------------------------------->  |                                      |
|                        |                                       |                                      |
|                        |                                       | modify bearer req(mme-teid,enb-teid  |
|                        |                                       | -----------------------------------> |
|                        |                                       |                                      |<enb-teid>
|                        |                                       |                                      |
|                        |   first donwlink data packet          |                                      |
|<---------------------- |<-----------------------------------------------------------------------------|
|                        |                                       |                                      |
|                        |                                       |                                      |
|                        |                                       |modify bearer resp(sgw-teid-u)        |
|                        |                                       |<-----------------------------------  | 



** Paging
Paging is from s1-release scenario
 ue: ECM=idle EMM=registered(guti,TAlist(TA1,TA2) in UE)

SGW get some data from the Internet, incoming donwlink data, sgw start to buffer them and request mme to estalbishment of E-RAB

SGW sent Downlink Data Notification(MME-TEID) to  mme
mme find subscirber with MME-TEID 

S-TMSI=MMEC+MTMSI 
S_TMSI is used to identify the subscirber

MME send Paging() to all the enbs(when s1-setup, enbs notify mme that its TAs) in the ta list(which is send to ue when attach accept).
enb1: own ip addr 13           enb2: ipaddr:12          mme: ipaddr:11
     Tal: Ta1, Ta2                  Tal: Ta2,Ta3              capacity: 25 


paging(S-TMSI,TA1+TA2)
-------------------------> enb1

paing(S-TMSI, TA2)
-------------------------> enb2
when ue recevied paing message from enb, it will send a service request nas messaeg to eNB


** detach procedure
detach procedure triggered by SIM card removed or cell phone is switched off.
The difference between detatch and s1-release is that detach will make SGW, MME, ENB delete all the ids it maintained for that SIM card.
while s1-release procedure is from enb(that lost connection with UE), so UE related info in ENB will be all removed, but SGW and MME may keep some info related only to UE 
other than related to enb.

ENB                                           MME                                           SGW                                           
|                                              |                                              |                                              
|                                              |                                              |                                              
|--------------------------------------------->|                                              |
| - Uplink NAS Transport (Detach Request)      |                                              |
|                                              |                                              |                                              
|                                              |                                              |                                              
|                                              |--------------------------------------------->|delete all the teid for this bearer (enb,sgw,mme),imsi
|                                              | - Delete Session Request                     |
|                                              |                                              |                                              
|                                              |<---------------------------------------------|
|                                              | - Delete Session Response                    |
|                                              |                                              |                                              
|                                              |--------------------------------------------->|delete all the teid(enb,sgw,mme),imsi
|                                              | - Delete Session Request                     |
|                                              |                                              |                                              
|                                              |<---------------------------------------------|
|                                              | - Delete Session Response                    |
                                              |                                              |                                              
|                                              |                                              |                                              
|<---------------------------------------------|                                              |
| - Downlink NAS Transport (Detach Accept)     |                                              |
|                                              |                                              |                                              
|                                              |                                              |                                              
|<---------------------------------------------|                                              |
| - UE Context Release Command                 |                                              |
| delet all s1 realated id                     |                                              |                                              
|                                              |                                              |                                              
|--------------------------------------------->|                                              |
| - UE Context Release Complete
| delete all the s1 related id                 |



** basic attach with imsi
triggered by a ue press a power button to switch on the phone



UE                               ENB                              MME                              HSS                              DNS                              SGW                              
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|A: RFC connection established   |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: NAS attach request(imsi,)    |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|A: [enb_s1_id]                  |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: initial ue message(enb_s1ap_ |                                |                                |                                |
|                                |id,TAI(tracking area identifica |                                |                                |                                |
|                                |tion in ue),NAS_attach_request( |                                |                                |                                |
|                                |imsi))                          |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|if sub in db,no authreq to hs|                                |                                |
|                                |A: <imsi,enb_s1ap_id> [mme_s1ap |                                |                                |                                |
|                                |_id,GUTI, MME-TEID]             |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------->|                                |                                |
|                                |                                |M: authentication info request( |                                |                                |
|                                |                                |imsi)                           |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------|                                |                                |
|                                |                                |M: allocation info answer(authe |                                |                                |
|                                |                                |ntication&security parameters)  |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: Downlink nas trasport(enb_s1 |                                |                                |                                |
|                                |ap_id,mme_s1ap_id,authenticatio |                                |                                |                                |
|                                |n request)                      |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |A: <mme_s1ap_id>                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: authentication Request       |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M; authentication response      |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: uplink nas trasnport(enb_s1a |                                |                                |                                |
|                                |p_id,mme_s1ap_id, authenticatio |                                |                                |                                |
|                                |n response)                     |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: DownlinkNASTransport (enb_s1 |                                |                                |                                |
|                                |ap_id,mme_s1ap_id,[securityMode |                                |                                |                                |
|                                |Command(cypher alg)])           |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                | tester calculate (cypher/inte) |                                |                                |                                |
|                                |key using kasme                 |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: [securityModeCommand]        |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: [{securityModeComplete}]     |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: UplinkNASTransport (enb_s1ap |                                |                                |                                |
|                                |_id,mme_s1ap_id,[{securityModeC |                                |                                |                                |
|                                |omplete}]                       |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------->|                                |                                |
|                                |                                |M; Update Location Request(IMSI)|                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------|                                |                                |
|                                |                                |M: Update Location answer(Qos p |                                |                                |
|                                |                                |rofile,APN)                     |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |---------------------------------------------------------------->|                                |
|                                |                                |M: APN                          |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<----------------------------------------------------------------|                                |
|                                |                                |M: PGW IP                       |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |M: create session request(MME-T |                                |                                |sgw restore imsi,mme-teid
|                                |                                |EID,IMSI)                       |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |A: <mme-teid,imsi>  [sgw-teid-c |                                |                                |
|                                |                                |,sgw-teid-u] c:control, u:user  |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |M: create session response(     |                                |                                |sgw-teid-c:senderFTEIDforctrlplane    
|                                |                                | sgw-teid-c,sgw-teid-u)         |                                |                                |sgw-teid-u:s1_U_SGW_FTEID in bearecontext
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |A: <SGW_TEID-u,SGW_TEID-c>      |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|                                |                                |                                |
|                                |M: initial context setup reques |                                |                                |                                |
|                                |t(enb_s1ap_id,mme_s1_id,SGW_TEI |                                |                                |                                |
|                                | SGW_TEID-u,                    |                                |                                |                                |
|                                |[{NAS_attach accept(GUTI,TALIST}|                                |                                |                                |
|                                |]))                             |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |<-------------------------------|enb-TEID:transportLayerAddress  |                                |                                |
|                                |A: <sgw_teid-u> [enb-TEID]      |                                |                                |                                |
|                                |                                |                                |                               G |                                |
|<-------------------------------|                                |                                |                                |                                |
|M: [{attach accept(guti,talist) |                                |                                |                                |                                |
|}]                              |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------|                                |                                |                                |                                |
|A: <guti,talist>                |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: InitialContextSetupResponse  |                                |                                |                                |
|                               G |(enb_s1ap_id,mme_s1_id,         |                                |                                |                                |
|                                |enb-TEID-U))                    |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |A: <enb TEID-U> temporarily     |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------------------------------------------------------------------------------------------------------------------------------------------->|
|M: first uplink data packet     |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|------------------------------->|                                |                                |                                |                                |
|M: Attach complete              |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |------------------------------->|                                |                                |                                |
|                                |M: S1AP.UplinkNASTransport(enb_ |                                |                                |                                |
|                                |s1ap_id,mme_s1_id,[{at          |                                |                                |                                |
|                                |tach complete}])                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|bearer context
|                                |                                |M: modify bearer request(mme-te |                                |                                |s1_eNodeB_FTEID
|                                |                                |id-c,enb-teid(ipaddr-update))   |                                |                                |is enb-teid
|                                |                                |                                |                                |                                |
|                                |                                |------------------------------------------------------------------------------------------------->|
|                                |                                |A: <enb-teid,ipaddr>            |                                |                                |
|                                |                                |                                |                                |                                |
|<-------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|M: first downlink data packet   |                                |                                |                                |                                |
|                                |                                |                                |                                |                                |
|                                |                                |<-------------------------------------------------------------------------------------------------|
|                                |                                |M: ModifyBearerResponse(sgw-teid-c)                                                                |
|                                |                                |                                |                                |                                |

after attach the ids in enb,mme,sgw
enb: enb-s1-id, mme-s1-id,      mme:imsi,enb-s1-id,mme-s1-id,                 sgw:imsi, mme-teid,
enb-teid, sgw-teid                  guti, mme-teid, sgw-teid                      sgw-teid,enb-teid

picture example: 
M means message() means parameter in message,[] means inteigiry protected message,{}means cyphered message 
A means Action. <> means stored [] means allocated

so after the attach, there are some value in the network element accordingly

ue: guti, tailist
enb: enb-s1-id, mme-s1-id, enb-teid, sgw-teid
sgw: imsi, mme-teid, sgw-teid, enb-teid
mme: ismi,enb-s1-id,mme-s1-id, guti, mme-teid, sgw-teid


note all the data packet won't pass mme, data only in sgw and enb(enb talk wih  ue via radio network)
other components are connected via real nettwork(core net work?) 
mme will only control the ue's guti and talist.
talist is the tas which not needed to do TAU for ue, if ue entered another tas not in talist, ue will perform TAU to mme,
mme will get updated where ue is










** Tracking Area Update
this procedure and be initiated by UE or just periodic.

*** intra mme TAU
**** ue initiated TAU 
When an UE detects it has entered a new Tracking Area(that is not in the list of TAIS when attach Accept),
it initiates a standalone tracking area update procedure.
***** ECM=IDLE ACTIVE FLAG = OFF
If the UE(in idle mode)has no UpLink data pending, it will initiate TAU with active_flag off


UE(ECM=idle,EMM=registered)                            ENB(no-ids)                                         MME (ECM=idle,EMM=registered)                                                     
                                                                                                               (imsi,guti,sgw-teid,mme-teid)
|                                                          |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|--------------------------------------------------------->|
| M TAU Request(TAI,guti,activeflag=off)                   |                                                          |
|                                                          |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|--------------------------------------------------------->|check if ths sub exists in cache/db using guti
| A [ebn-s1ap-id]                                          |                                                          |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M Initial UE message( enb-s1ap-id(TAU Request(TAI,acti   |
|                                                          | vef=off))                                                |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | A [mme-s1ap-id] <enb-s1ap-id>                            |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | M Downlink NAS transport(enb-s1ap-id,mme-s1ap-id,TAU a   |
|                                                          | ccept((newtalist),GUTI))                                 |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | A  <mme-s1ap-id>                                         |
|                                                          |                                                          |
|                                                          |                                                          |
| <------------------------------------------------------- |                                                          |
| M TAU Accept(TAI,GUTI)                                   |                                                          |
|                                                          |                                                          |
|                                                          |                                                          |
|--------------------------------------------------------->|                                                          |
| M TAU complete                                           |                                                          |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M Uplink NAS transport(enb-s1ap-id,mme-s1ap-id,TAUComp   |
|                                                          | lete)                                                    |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | M UE Context release command(enb-s1ap-id,mme-s1ap-id)    |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | <------------------------------------------------------- |
|                                                          | A  delete all the s1ap-ids(mme, enb)                     |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | M UE Context release complete(enb-s1ap-id,mme-s1ap-id)   |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          |                                                          |
|                                                          | -------------------------------------------------------> |
|                                                          | A  delete all the s1ap-ids(mme, enb)                     |


***** ECM=IDLE ACTIVE FLAG = ON
If the UE (in idle mode) has UpLink data pending (or UpLink signalling not related to TAU), the MME re-establish the radio and S1 bearers for all i
active EPS bearer contexts. The UE indicates this request to establish the User Plane (and to keep NAS signalling connection after TAU completion) by setting an "active" flag. 

UE                                                      ENB                                                     MME(ECM=idle,EMM=registered)                            SGW                                                     
 (ECM=idle,EMM=registered)                              (no-ids)                                (imsi,guti,sgw-teid,mme-teid)                           (imsi,sgw-teid,mme-teid)
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  M TAU Request(TAI,activeflag=on)                      |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  A [ebn-s1ap-id] ECM(idle ---> connected)              |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  M Initial UE message( enb-s1ap-id(TAU Request(TAI,acti|                                                        |
|                                                        |vef=on))                                                |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  A [mme-s1ap-id] <enb-s1ap-id> ECM(indle-->connected)  |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |<-------------------------------------------------------|                                                        |
|                                                        |  M Initial ContextSetup Request(enb-s1ap-id,mme-s1ap-i |                                                        |
|                                                        |d,sgw-teid,TAU accept((newtalist),GUTI))                |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |<-------------------------------------------------------|                                                        |
|                                                        |  A  [enb-teid] <mme-s1ap-id,sgw-teid>                  |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |M Context Setup Response(enb-s1-id,mme-s1-id,enb-teid,  |                                                        |
|                                                        |          TAU Accept(TAList,GUTI)                       |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  A  <enb-teid>                                         |                                                        |
|                                                        |                                                        |                                                        |                                                        
|<-------------------------------------------------------|                                                        |                                                        |
|  M TAU Accept(TAI,GUTI)                                |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|------------------------------------------------------->|                                                        |                                                        |
|  M TAU Complete                                        |                                                        |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |------------------------------------------------------->|                                                        |
|                                                        |  M TAU Complete in UL NAS Transport                    |                                                        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |------------------------------------------------------->|
|                                                        |                                                        |  M ModifybearerRequest(mme-teid-id,enb-teid-id)        |
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |                                                        |                                                        
|                                                        |                                                        |<-------------------------------------------------------|   
|                                                        |                                                        | M ModifybearerResponse(mme-s1ap-id)                    |


***** ECM=CONNECTED
only update the TA List, all enb-s1ap-id, enb-teid, mme-s1ap=id, sgw-teid, mme-teid no need to update at all.

***** intra MME TAU with SGW relocation ECM=CONNECTED
case id:  NS_130_4_0001

ENB                                             MME                                                tSGW                                             sSGW
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Uplink NAS Transport (Tracking Area Update Req|                                                 |                                                 |
|uest(GUTI,TAI,))                                 |                                                 |                                                 |
|                                                 |DNSquery with tac to see if sgw need relocated   |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Create Session Request                        |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Create Session Response                       |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |-------------------------------------------------------------------------------------------------->|
|                                                 | - Delete Session Request                                                                          |
|                                                 |                                                 |                                                 |
|                                                 |<--------------------------------------------------------------------------------------------------|
|                                                 | - Delete Session Response                                                                         |
|                                                 |                                                 |                                                 |
|<------------------------------------------------|                                                 |                                                 |
| - Initial Context Setup Request (Tracking Area U|                                                 |                                                 |
|pdate Accept)                                    |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Initial Context Setup Response                |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|------------------------------------------------>|                                                 |                                                 |
| - Uplink NAS Transport (Tracking Area Update Com|                                                 |                                                 |
|plete)                                           |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |------------------------------------------------>|                                                 |
|                                                 | - Modify Bearer Request                         |                                                 |
|                                                 |                                                 |                                                 |
|                                                 |<------------------------------------------------|                                                 |
|                                                 | - Modify Bearer Response                        |                                                 |
|                                                 |                                                 |                                                 |

**** periodic TAU
In addition, an EMM-REGISTERED and ECM-IDLE state UE performs periodic Tracking Area Update with the network after the expiry of the periodic TAU timer (T3412).
The     value of timer is sent by the network to the UE in the ATTACH ACCEPT message (and can be sent in the TRACKING AREA UPDATE ACCEPT message). Periodic tracking area 
updateing is used to periodically notify the availability of the EMM-IDLE state UE to the network. 
    
*** inter mme TAU with ACTIVE FLAG= OFF
case id:NS_129_31_0001
** Handover procedure
When a UE has connection to an eNB(through some cell), it is constantly measuring the signal strenths of all the
cell around it.
UE  EMM=registered ECM=connected
while UE is moving, it notices that a new cell is having a significantly stronger signal
than the current cell,then UE will send a Measurement Report to the source eNB
about the event
When source eNB receives the Measurment report it'll make a decision about performing a handover

precondition: ATTACH and default bearer setup

*** intra mme handover through s1 interface without SGW relocation
when ue handover from source enb to target enb, the downlink data will lost it destination for a short time.
So in S1 handover, SGW will play as a route, it forward downlink data to target enb, when SGW send downlink
data to source eNB, eNB will forward it to SGW, and SGW forward it to Target eNB, and target eNB will buffer
these data till ue handover to target ENB complete.
case id:NS_70_7_0001 without SGW relocation
Source eNB                          MME                                 Target eNB                            SGW                                 UE                                  
enb-teid                           mme-teid                                                               sgw-teid-c/u
mme-s1ap-id                        sgw-teid-c/u                                                           mme-teid
enb-s1ap-id                        mme/enb-s1ap-id                                                        enb-tid
sgw-teid-u
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------------------------------------DL------------------------------------------|                                    |
|                                    |                                    |                                    |                                    |                                    
|------------------------------------------------------------------UL----------------------------------------->|                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|HandoverRequired(mme-s1apid,tenb-id)|                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    | Handover Request(mme-s1ap-id-tenb, |                                    |                                    |
|                                    |sgw-teid-u,uecontext)               |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |A:[tenb-s1id,tebTEID,tebDLTEID]     |                                    |                                    |
|                                    | <sgw-teid-u,mme-s1ap-id>           |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |HandoverRequestAck(tenb-s1id,tenbDLTEID)|                                |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |Create IndirectDataForwardingTunnel Request(tenbDLTEID)                  |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |A:<tenbDLTEID>,[SGW-DL-TEID]        |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Create Indirect Data Forwarding Tunnel Response(SGW-DL-TEID)           |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  Handover command(SGW-DL-TEID)     |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  A:<SGW-DL-TEID>                   |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|enb-TEID                            |                                    |                                    |                                    |                                    
|<-----------------------------------------------------------------DL------------------------------------------|      now a dl data will from       |
|                                    |                                    |                         sgw-dl-teid|    sgw---->senb---->sgw----->tenb  |                                    
|-----------------------------------------------------------------DL----->|                                    |    enb-teid  sgw-dl-teid  tebDLTEID|
|                                    |                                    |tebDLTEID                           |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  eNB STATUS TRANSFER               |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |----------------------------------->|                                    |                                    |
|                                    |  Mme STATUS Tansfer                |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                          sgw-teid  |                                    |                                    
|                                    |                                    |-----------UL---------------------->|   now targe enb establish with ue  |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |<------------------------------------------------------------------------|
|                                    |                                    |   Handover confirmed                                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<-----------------------------------|                                    |                                    |
|                                    |  Handover NOTIFY                   |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Modify bearer request(mme-teid,tenb-teid)                              |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Modify bearer response(sgw-teid-u)                                     |                                    |
|                                    |                                    | teb-teid                           |                                    |                                    
|                                    |                                    |<----------DL-----------------------|    now DL using tenb-teid instead  |                                    
|                                    |                                    |                                    |    of  forward tunnel              |                                    
|                                    |                                    |                                    |                                    |                                    
|<-----------------------------------|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMMAND        |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|----------------------------------->|                                    |                                    |                                    |
|  UE CONTEXT RELEASE COMPLETE       |                                    |                                    |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |------------------------------------------------------------------------>|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Request                         |                                    |
|                                    |                                    |                                    |                                    |                                    
|                                    |                                    |                                    |                                    |                                    
|                                    |<------------------------------------------------------------------------|                                    |
|                                    |  Delete Indirect Data Forwarding Tunnel Response                        |                                    |


*** intra mme s1 handover with SGW relocation
The differce between with/without SGW relocation is that
SGW relocation means that new sgw-teid-c/u are needed, so extra Create Session Req/Resp are needed for target SGW.
and the IDFT is different
DL data flow is :  sSGW-> sENB-> sSGW ->  (tSGW) -> tENB

tSGW is an extra one compared to without SGW relocation

So there are two IDFT, 
one is 
case id: NS_130_2_0001 without SGW relocation

SENB                                     MME                                    tSGW                             targetENB                                    sSGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required                   |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Session Request              |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | A:[sgw-teid-c,sgw-teid-u]             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | Create Session Response(sgw-teid-c/u) |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - Handover Request                                                            |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Handover Request Acknowledge(tenb-teid,enb-dl-teid)                          |                                       |
|                                       |<tenb-teid>                            |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Create Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Request(tenb-dl-teid)               |tenb-dl-teid                           |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Create Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Response(tSGW-dlteid)               |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request(tSGW-dlteid)                                                         |<tSGW-dlteid>
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response(sSGW-dlteid)                                                        |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command(sSGW-dlteid)       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|enb-teid                               |                                       |                                       |                                       |
|<-------------------------------------------------------------------------DL-----------------------------------------------------------------------------------|
|--------------------------------------------------------------------------DL---------------------------------------------------------------------------------->|sSGW-dl-teid
|                                                                     tSGW-dltid|<---------------------DL-------------------------------------------------------|
|                                       |                                       |----------------DL-------------------->|tenb-dl-teid                           |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - ENB Status Transfer                 |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |------------------------------------------------------------------------------>|                                       |
|                                       | - MME Status Transfer                                                         |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<------------------------------------------------------------------------------|                                       |
|                                       | - Handover Notify                                                             |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Modify Bearer Request(tenb-teid)    |<tenb-teid>                            |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Modify Bearer Response              |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |----------------DL-------------------->|tenb-teid                           |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-----------------------------------------Resource release for whole handover.----------------------------------------------------------------------------------|                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Request                             |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Session Request                                                                                              |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Delete Indirect Data Forwarding Tunn|                                       |                                       |
|                                       |el Response                            |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Session Response                                                                                             |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Delete Indirect Data Forwarding Tunnel Response                                                                     |
|                                       |                                       |                                       |                                       |

*** x2 handover without SGW relocation
precondition:
source eNb and Target eNB complete Handover Execution Forwoarding of data through x2 interface

Before the message flow involved in MME, target eNB and source eNB exhange the info firstly.
when ue establish with target eNB, target eNB will send message to MME about it's teb-teid.

testcase id: NS_13_2_0002  
Target eNB                              MME                                   SGW     
|                                       |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
| Path Switch Request(teb-s1id,teb-teid |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
|A:<teb-s1id,teb-teid>                  |                                      |
|                                       |                                      |
|                                       | -----------------------------------> |
|                                       | Modify bearer request(teb-teid)      |
|                                       |                                      |
|                                       |                                      |
|                                       | <----------------------------------- |
|                                       | Modify bearer response               |
|                                       |                                      |
|                                       |                                      |

| <-----------------------------------  |                                      |
| Path Switch Request Ack               |                                      |



*** x2 handover with SGW relocation
precondition:
source eNb and Target eNB complete Handover Execution Forwoarding of data through x2 interface

Before the message flow involved in MME, target eNB and source eNB exhange the info firstly.
when ue establish with target eNB, target eNB will send message to MME about it's teb-teid.

testcase id: NS_130_3_0001
Target eNB                              MME                                   tSGW     
|                                       |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
| Path Switch Request(teb-s1id,teb-teid |                                      |
|                                       |                                      |
|-------------------------------------->|                                      |
|A:<teb-s1id,teb-teid>                  |                                      |
|                                       |                                      |
|                                       | -----------------------------------> |
|                                       | create session request(teb-teid)     |<teb-teid>[sgw-teid-c/u]
|                                       |                                      |
|                                       |                                      |
|                                       | <----------------------------------- |
|                                       | create session response(sgw-teid-c/u)|
|                                       |                                      |
|                                       |                                      |
| <-----------------------------------  |                                      |
| Path Switch Request Ack(sgw-teid-u)   |                                      |


**** How MME know this handover need SGW relocation?
when MME received target-enb tai is different with the source-enb ta list, it will trigger DNS check state, if sgw is as the same hostname and ip, then, no sgw relocation.



*** inter mme s1 handover without SGW relocation 
source mme sut case id:NS_129_11_0002
target mme sut case id:  NS_129_22_0001

sENB                                    sMME                                    tMME                                    tENB                                    SGW
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - Handover Required(tenb-id)          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       |Forward Relocation Request(sgw-teid-u, |<sgw-teid-u>[sgw-teid-c]               |                                       |
|                                       |  imsi,tenbid)                         |                                       |                                       |
|                                       |                                       |-------------------------------------->|                                       |
|                                       |                                       |  -Handover Request(sgw-teid-u)        |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<--------------------------------------|                                       |
|                                       |                                       |HandoverRequestAck(enb-dl-teid,enb-teid)|                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       |Forward Relocation Response(enb-dl-teid)|                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Create Indirect Data Forwarding Tunnel Request(enb-dl-teid)                                                         |
|                                       |                                       |                                       |                                       |
|                                       |<----------------------------------------------------------------------------------------------------------------------|
|                                       | - Create Indirect Data Forwarding Tunnel Response(sgw-dl-teid)                                                        |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - Handover Command(sgw-dl-teid)       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - ENB Status Transfer                 |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Forward Access Context Notification |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Forward Access Context Acknowledge  |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |-------------------------------------->|                                       |
|                                       |                                       | - MME status transfer                 |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<--------------------------------------|                                       |
|                                       |                                       | - Handover Notify                     |                                       |
|                                       |                                       |                                       |                                       |
|                                       |<--------------------------------------|                                       |                                       |
|                                       | - Forward Relocation Complete Notifica|                                       |                                       |
|                                       |tion                                   |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |-------------------------------------->|                                       |                                       |
|                                       | - Forward Relocation Complete Acknowle|                                       |                                       |
|                                       |dge                                    |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |                                       |------------------------------------------------------------------------------>|
|                                       |                                       |  - Modify Bearer Request (tenb-teid)                                          |
|                                       |                                       |                                       |                                       |
|                                       |                                       |<------------------------------------------------------------------------------|
|                                       |                                       |  - Modify Bearer Response                                                     |
|                                       |                                       |                                       |                                       |
|<--------------------------------------|                                       |                                       |                                       |
| - UE Context Release Command          |                                       |                                       |                                       |
|                                       |                                       |                                       |                                       |
|                                       |---------------------------------------------------------------------------------------------------------------------->|
|                                       | - Delete Indirect Data Forwarding Tunnel Request                                                                      |
|                                       |                                       |                                       |                                       |
|-------------------------------------->|                                       |                                       |                                       |
| - UE Context Release Complete         |                                       |                                       |                                       |

* EPS session management related
Default bearer:   with new PDN addr/ip, qci to create, with a ebi, using (create session req) to create
dedicated bearer: without PDN addr/ip, but qci different from the linked bearer,tft, with a ebi, using (create bearer req) to create

dedicated bearer  linked to the default bearer, on top of that default bearer, but with
different qci, same PDN addr/ip, same pdn network.

*** Default EPS bearer context activation procedure
eg. ue want a voip call, it will initiate a IMS  default bearer 
ENB:  ------>  SUT - Uplink NAS Transport (PDN Connectivity Request)
SGW:  <------  SUT - Create Session Request
SGW:  ------>  SUT - Create Session Response
ENB:  <------  SUT - E-RAB Setup Request (Activate Default EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Setup Response
ENB:  ------>  SUT - Uplink NAS Transport (Activate Default EPS Bearer Context Accept)
SGW:  <------  SUT - Modify Bearer Request
SGW:  ------>  SUT - Modify Bearer Response

the difference between  initial context setup request and activate eps bearer context is the former is for establishing the first default bearer, and later for not first default bearer

*** Dedicated EPS bearer context activation procedure
then ue create the dedicated bearer on that default bearer with different qci
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Allocation Request)
SGW:  <------  SUT - Bearer Resource Command
SGW:  ------>  SUT - Create Bearer Request
ENB:  <------  SUT - E-RAB Setup Request (Activate Dedicated EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Setup Response
ENB:  ------>  SUT - Uplink NAS Transport (Activate Dedicated EPS Bearer Context Accept)
SGW:  <------  SUT - Create Bearer Response


if a Default bearer is deleted with (delete session req), then the dedicated bearer linked to it also be removed.
SGW:  <------  SUT - Delete Session Request
SGW:  ------>  SUT - Delete Session Response
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)

the difference between ue context release and E-RAB Release Command is the former ENB will remove all the bearers context and the s1ap-id, and later ENB only remove bearers context only.

if a dedicated bearer is deleted with (delete bearer req), then the default bearer will still exist till using(delete session req) to it.
ue stop the voip call:
ENB:  ------>  SUT - Uplink NAS Transport (Bearer Resource Modification Request) 
SGW:  <------  SUT - Bearer Resource Command
SGW:  ------>  SUT - Delete Bearer Request
ENB:  <------  SUT - E-RAB Release Command (Deactivate EPS Bearer Context Request)
ENB:  ------>  SUT - E-RAB Release Response
ENB:  ------>  SUT - Uplink NAS Transport (Deactivate EPS Bearer Context Accept)
SGW:  <------  SUT - Delete Bearer Response

** ESM procedures are:


*** EPS bearer context modification procedure
*** EPS bearer context deactivation procedure
*** UE requested PDN connectivity procedure
*** UE requested PDN disconnect procedure
*** UE requested bearer resource modification procedure.


* EPS SRVCC and CSFB
4g-lte-world.blogspot.fi/2012/05/default-bearer-dedicated-bearer-what.html

Long Term Evolution(LTE) is heralded as the next big thing for mobile networks
One of the key issues of LTE is the delivery of voice services. Voice service continuity is not guaranteed when a Voice over IP(VoIP) subscriber roams between the LTE coverage area and other wireless
network---it is a significatn challenge to deliver voice over LTE networks

to overcome the LTE voice issues. During this evaluation process two options are gaining significant momentum: Circuit Switched Fall Back (CSFB) and LTE VoIP-based Single Radio Voice Call 
Continuity (SRVCC). The latter is widely supported in the industry and has been recommended by the LTE OneVoice Initiative, which has the support of some of the world’s largest operators and network 
equipment providers and has been endorsed by the GSM Association (GSMA)


LTE voice issue:
in overalll 2/3/4G network, voice call has two forms:
call suppported by IMS Core
  either use 3g radio  or 4g radio.
tranditional circuit call

in LTE env(EUTRAN), the voice call is from ENB--->SGW---->IMS Core
in UTRAN, the voice call is from UTRAN----->MSC--------->IMS Core
tranditoinal circuit call is from UTAN------>MSC (no IMS core)

So when UE move between those 2/3/4g network, there are 2 different mechanism to support voice call.
SRVCC is for handing over from SGW----->IMS  to MSC----->IMS
CSFB  is for 

** SRVCC (Single Radio Voice Call Coninuity)
widely supported in the industry and has been recommended by the LTE OneVoice Initiative.
if mobile only single Mode, SRVCC capable
while it is able to transmit or receive on only one of these access networks at a given time.  

    |----------------UTRAN---------------------MSC-------------
    |                 |                         |             |
    |                 |--------SGSN             |             |
(Single Mode)                   |               |             |
   UE                  --------MME--------------           IMS Core  
    |                  |         |______________              |
    |                  |                       |              |
    |---------------EUTRAN---------------------SGW------------|

voice bearer before handover
UE----->EUTAN_------->SGW-------->IMS Core

voice bearer after handover
UE------>UTRAN---------->MSC------>IMS Core




** CSFB  (Circuit Swithed Fall Back)
The main idea behind CS fallback is to allow UEs to camp on LTE and utilize the LTE for data services
but resuse the GSM,WCDMA,CDMA network for circuit-switched voice services.

this required mobile support dual mode

____________UTRAN_____________SGSN____________
|              |               |             |        
|              |               |             |
(Dual Mode)    |_______________|_____________|
UE                             |             MSC  
|                              |             |
|_________E-UTRAN____________MME_____________|

ue combined attach with MME and MSC, The combined EPS attach procedure is used by a CSFB enabled UE to attach both EPS and non-EPS services and associate itself in SGs-Interface. 
The pre-condition is that the UE should send Combined-IMSI AttachRequest to MME. And a physical connection between the MSC/VLR and MME should exist. 
in CS domain,voice bearer path:
ue---------UTRAN---------MSC
and at the same time
in PS domain, data bearer path:
ue-------e_UTRAN--------SGSN

*** combined attach procedure
Normal attach procedure with AttachReq(Attach Type=Combined Attach), attatch to MSC also.
After Create Session Req/Res,

      SGsAP-update-Location-Req    
MME   -------------------------------------->MSC
         SGSAP-update-location-Accept
So mme has a link with MSC

*** MO CSFB call- UE idle
----------------------------
combined attach
----------------------------
S1 release
------------------------
| ENB:  ------>  SUT - Uplink NAS Transport (Extended Service Request)
| ENB:  <------  SUT - Initial Context Setup Request(with CS fallback indicator,LAI)
| ENB:  ------>  SUT - Initial Context Setup Response(ENB know ue will move to UTRAN)
| ENB:  ------>  SUT - UE Context Release Request
| SGW:  <------  SUT - Release Access Bearer Request
| SGW:  ------>  SUT - Release Access Bearer Response
| ENB:  <------  SUT - UE Context Release Command
| ENB:  ------>  SUT - UE Context Release Complete
-------------------------------------------------------
 inter system RAU
------------------------------------------------------
UE to MSC with CS MO call
------------------------------------------------------
inter system TAU
------------------------------------------------

*** inter-system RAU procedure
the Routing Area Update takes place when a UE that is registered with an MME selects a UTRAN cell.
in this case, the US changes to a Routing Area that the UE has not yet registered with the network.

UE will start a new register to UTRAN to SGSN, and SGSN will ask mme about the contexts

      SGSN-Context-Request(RAI,P-TMSI,RAT Type)
SGSN------------------------> MME                  

    Context Response
   <-------------------------

    Context Acknowlege
   -------------------------->



*** inter-system TAU procedure involve SGSN
 ENB:  ------>  SUT - Uplink NAS Transport (Tracking Area Update Request)
| SGSN: <------  SUT - SGSN Context Request
| SGSN: ------>  SUT - SGSN Context Response
| HSS:  <------  SUT - Authentication Information Request
| HSS:  ------>  SUT - Authentication Information Answer
| ENB:  <------  SUT - Downlink NAS Transport (Authentication Request)
| ENB:  ------>  SUT - Uplink NAS Transport (Authentication Response)
| ENB:  <------  SUT - Downlink NAS Transport (Security Mode Command)
| ENB:  ------>  SUT - Uplink NAS Transport (Security Mode Complete)
| SGSN: <------  SUT - SGSN Context Acknowledge
| SGW:  <------  SUT - Create Session Request
| SGW:  ------>  SUT - Create Session Response
| HSS:  <------  SUT - Update Location Request
| HSS:  ------>  SUT - Update Location Answer
| SGS:  <------  SUT - SGsAP Location Update Request
| SGS:  ------>  SUT - SGsAP Location Update Accept
| ENB:  <------  SUT - Initial Context Setup Request (Tracking Area Update Accept)
| ENB:  ------>  SUT - Initial Context Setup Response
| ENB:  ------>  SUT - Uplink NAS Transport (Tracking Area Update Complete)
| SGW:  <------  SUT - Modify Bearer Request
| SGW:  ------>  SUT - Modify Bearer Response



